{"version":3,"sources":["../src/chrome/chromeConnection.ts"],"names":[],"mappings":"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","file":"chromeConnection.js","sourcesContent":["/*---------------------------------------------------------\n * Copyright (C) Microsoft Corporation. All rights reserved.\n *--------------------------------------------------------*/\n\nimport * as WebSocket from 'ws';\n\nimport { telemetry } from '../telemetry';\nimport { StepProgressEventsEmitter, IObservableEvents, IStepStartedEventsEmitter } from '../executionTimingsReporter';\nimport * as errors from '../errors';\nimport * as utils from '../utils';\nimport { logger } from 'vscode-debugadapter';\nimport { ChromeTargetDiscovery, TargetVersions, Version } from './chromeTargetDiscoveryStrategy';\n\nimport { Client, LikeSocket } from 'noice-json-rpc';\n\nimport { Protocol as Crdp } from 'devtools-protocol';\n\nimport { CRDPMultiplexor } from './crdpMultiplexing/crdpMultiplexor';\nimport { WebSocketToLikeSocketProxy } from './crdpMultiplexing/webSocketToLikeSocketProxy';\n\nexport interface ITarget {\n    description: string;\n    devtoolsFrontendUrl: string;\n    id: string;\n    thumbnailUrl?: string;\n    title: string;\n    type: string;\n    url?: string;\n    webSocketDebuggerUrl: string;\n    version: Promise<TargetVersions>;\n}\n\nexport type ITargetFilter = (target: ITarget) => boolean;\nexport interface ITargetDiscoveryStrategy {\n    getTarget(address: string, port: number, targetFilter?: ITargetFilter, targetUrl?: string): Promise<ITarget>;\n    getAllTargets(address: string, port: number, targetFilter?: ITargetFilter, targetUrl?: string): Promise<ITarget[]>;\n}\n\n/**\n * A subclass of WebSocket that logs all traffic\n */\nclass LoggingSocket extends WebSocket {\n    constructor(address: string, protocols?: string | string[], options?: WebSocket.ClientOptions) {\n        super(address, protocols, options);\n\n        this.on('error', e => {\n            logger.log('Websocket error: ' + e.toString());\n        });\n\n        this.on('close', () => {\n            logger.log('Websocket closed');\n        });\n\n        this.on('message', msgStr => {\n            let msgObj: any;\n            try {\n                msgObj = JSON.parse(msgStr.toString());\n            } catch (e) {\n                logger.error(`Invalid JSON from target: (${e.message}): ${msgStr}`);\n                return;\n            }\n\n            if (msgObj && !(msgObj.method && msgObj.method.startsWith('Network.'))) {\n                // Not really the right place to examine the content of the message, but don't log annoying Network activity notifications.\n                if ((msgObj.result && msgObj.result.scriptSource)) {\n                    // If this message contains the source of a script, we log everything but the source\n                    msgObj.result.scriptSource = '<removed script source for logs>';\n                    logger.verbose('← From target: ' + JSON.stringify(msgObj));\n                } else {\n                    logger.verbose('← From target: ' + msgStr);\n                }\n            }\n        });\n    }\n\n    public send(data: any, opts?: any, cb?: (err: Error) => void): void {\n        const msgStr = JSON.stringify(data);\n        if (this.readyState !== WebSocket.OPEN) {\n            logger.log(`→ Warning: Target not open! Message: ${msgStr}`);\n            return;\n        }\n\n        super.send.apply(this, arguments);\n        logger.verbose('→ To target: ' + msgStr);\n    }\n}\n\nexport interface IChromeError {\n    code: number;\n    message: string;\n    data: string;\n}\n\n/**\n * Connects to a target supporting the Chrome Debug Protocol and sends and receives messages\n */\nexport class ChromeConnection implements IObservableEvents<IStepStartedEventsEmitter> {\n    protected static ATTACH_TIMEOUT = 10000; // ms\n\n    private _socket: WebSocket;\n    private _crdpSocketMultiplexor: CRDPMultiplexor;\n    private _client: Client;\n    private _targetFilter: ITargetFilter;\n    private _targetDiscoveryStrategy: ITargetDiscoveryStrategy & IObservableEvents<IStepStartedEventsEmitter>;\n    private _attachedTarget: ITarget;\n    public readonly events: StepProgressEventsEmitter;\n\n    constructor(targetDiscovery?: ITargetDiscoveryStrategy & IObservableEvents<IStepStartedEventsEmitter>, targetFilter?: ITargetFilter) {\n        this._targetFilter = targetFilter;\n        this._targetDiscoveryStrategy = targetDiscovery || new ChromeTargetDiscovery(logger, telemetry);\n        this.events = new StepProgressEventsEmitter([this._targetDiscoveryStrategy.events]);\n    }\n\n    public get isAttached(): boolean { return !!this._client; }\n\n    public get api(): Crdp.ProtocolApi {\n        return this._client && this._client.api();\n    }\n\n    public get attachedTarget(): ITarget {\n        return this._attachedTarget;\n    }\n\n    public setTargetFilter(targetFilter?: ITargetFilter) {\n        this._targetFilter = targetFilter;\n    }\n\n    /**\n     * Attach the websocket to the first available tab in the chrome instance with the given remote debugging port number.\n     */\n    public attach(address = '127.0.0.1', port = 9222, targetUrl?: string, timeout?: number, extraCRDPChannelPort?: number): Promise<void> {\n        return this._attach(address, port, targetUrl, timeout, extraCRDPChannelPort)\n            .then(() => { });\n    }\n\n    public attachToWebsocketUrl(wsUrl: string, extraCRDPChannelPort?: number): void {\n        /* __GDPR__FRAGMENT__\n           \"StepNames\" : {\n              \"Attach.AttachToTargetDebuggerWebsocket\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\" }\n           }\n         */\n        this.events.emitStepStarted('Attach.AttachToTargetDebuggerWebsocket');\n        this._socket = new LoggingSocket(wsUrl, undefined, { headers: { Host: 'localhost' }});\n        if (extraCRDPChannelPort) {\n            this._crdpSocketMultiplexor = new CRDPMultiplexor(this._socket as any as LikeSocket);\n            new WebSocketToLikeSocketProxy(extraCRDPChannelPort, this._crdpSocketMultiplexor.addChannel('extraCRDPEndpoint')).start();\n            this._client = new Client(this._crdpSocketMultiplexor.addChannel('debugger'));\n        } else {\n            this._client = new Client(<WebSocket>this._socket as any);\n        }\n\n        this._client.on('error', e => logger.error('Error handling message from target: ' + e.message));\n    }\n\n    public getAllTargets(address = '127.0.0.1', port = 9222, targetFilter?: ITargetFilter, targetUrl?: string): Promise<ITarget[]> {\n        return this._targetDiscoveryStrategy.getAllTargets(address, port, targetFilter, targetUrl);\n    }\n\n    private _attach(address: string, port: number, targetUrl?: string, timeout = ChromeConnection.ATTACH_TIMEOUT, extraCRDPChannelPort?: number): Promise<void> {\n        let selectedTarget: ITarget;\n        return utils.retryAsync(() => this._targetDiscoveryStrategy.getTarget(address, port, this._targetFilter, targetUrl), timeout, /*intervalDelay=*/200)\n            .catch(err => Promise.reject(errors.runtimeConnectionTimeout(timeout, err.message)))\n            .then(target => {\n                selectedTarget = target;\n                return this.attachToWebsocketUrl(target.webSocketDebuggerUrl, extraCRDPChannelPort);\n            }).then(() => {\n                this._attachedTarget = selectedTarget;\n            });\n    }\n\n    public run(): Promise<void> {\n        // This is a CDP version difference which will have to be handled more elegantly with others later...\n        // For now, we need to send both messages and ignore a failing one.\n        return Promise.all([\n            this.api.Runtime.runIfWaitingForDebugger(),\n            (<any>this.api.Runtime).run()\n        ])\n        .then(() => { }, () => { });\n    }\n\n    public close(): void {\n        this._socket.close();\n    }\n\n    public onClose(handler: () => void): void {\n        this._socket.on('close', handler);\n    }\n\n    public get version(): Promise<TargetVersions> {\n        return this._attachedTarget.version\n            .then(version => {\n                return (version) ? version : new TargetVersions(Version.unknownVersion(), Version.unknownVersion());\n            });\n    }\n}"],"sourceRoot":"../.."}